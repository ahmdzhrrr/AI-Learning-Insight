openapi: 3.0.3
info:
  title: AI Learning Insight API
  version: 1.0.0
servers:
  - url: http://localhost:5000

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ApiStatus:
      type: string
      enum: [success, fail, error]
    User:
      type: object
      properties:
        id: { type: string, format: uuid }
        email: { type: string, format: email }
        name: { type: string }
    Student:
      type: object
      properties:
        id: { type: string, format: uuid }
        user_id: { type: string, format: uuid }
        name: { type: string }
        email: { type: string, format: email }
        class: { type: string, nullable: true }
        created_at: { type: string, format: date-time }
    Metric:
      type: object
      properties:
        id: { type: string, format: uuid }
        date: { type: string, format: date, example: "2025-11-10" }
        study_hours: { type: number, minimum: 0, maximum: 5 }
        attendance: { type: integer, minimum: 1, maximum: 5 }
        assignment_completion: { type: integer, minimum: 1, maximum: 5 }
        motivation: { type: integer, minimum: 1, maximum: 5 }
        stress_level: { type: integer, minimum: 1, maximum: 5 }
        discussions: { type: integer, minimum: 0, maximum: 5 }
        resources: { type: integer, minimum: 0, maximum: 5 }
        created_at: { type: string, format: date-time, nullable: true }
        updated_at: { type: string, format: date-time, nullable: true }
    InsightReason:
      type: object
      properties:
        key: { type: string, example: "study_hours" }
        op:  { type: string, example: ">=" }
        value:
          oneOf: [{ type: number }, { type: string }]
        actual:
          oneOf: [{ type: number }, { type: string }]
          nullable: true
    Insight:
      type: object
      properties:
        label: { type: string, enum: [Fast, Consistent, Reflective] }
        confidence: { type: number, minimum: 0, maximum: 1 }
        reasons:
          type: array
          items: { $ref: "#/components/schemas/InsightReason" }
        updated_at: { type: string, format: date-time }

paths:
  /:
    get:
      summary: Root ping
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "âœ… Backend ready" }

  /auth/register:
    post:
      summary: Register user + student
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, name]
              properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 6 }
                name: { type: string }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { $ref: "#/components/schemas/ApiStatus" }
                  data:
                    type: object
                    properties:
                      token: { type: string }
                      user: { $ref: "#/components/schemas/User" }
                      studentId: { type: string, format: uuid }
        "400": { description: Bad Request }

  /auth/login:
    post:
      summary: Login and get JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { $ref: "#/components/schemas/ApiStatus" }
                  data:
                    type: object
                    properties:
                      token: { type: string }
        "401": { description: Unauthorized }

  /auth/me:
    get:
      security: [{ bearerAuth: [] }]
      summary: Get current user (from JWT)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { $ref: "#/components/schemas/ApiStatus" }
                  data:
                    type: object
                    properties:
                      user: { $ref: "#/components/schemas/User" }
        "401": { description: Unauthorized }

  /students/me:
    get:
      security: [{ bearerAuth: [] }]
      summary: Get my student profile
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { $ref: "#/components/schemas/ApiStatus" }
                  data: { $ref: "#/components/schemas/Student" }
        "401": { description: Unauthorized }
        "404": { description: Not Found }

  /metrics:
    post:
      security: [{ bearerAuth: [] }]
      summary: Add one metric row
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: "#/components/schemas/Metric"
              required:
                - date
                - study_hours
                - attendance
                - assignment_completion
                - motivation
                - stress_level
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { $ref: "#/components/schemas/ApiStatus" }
                  data:
                    type: object
                    properties:
                      id: { type: string, format: uuid }
        "400": { description: Bad Request }
        "401": { description: Unauthorized }

  /metrics/me:
    get:
      security: [{ bearerAuth: [] }]
      summary: List my metrics
      parameters:
        - in: query
          name: limit
          schema: { type: integer, default: 30, minimum: 1, maximum: 200 }
        - in: query
          name: offset
          schema: { type: integer, default: 0, minimum: 0 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { $ref: "#/components/schemas/ApiStatus" }
                  data:
                    type: object
                    properties:
                      metrics:
                        type: array
                        items: { $ref: "#/components/schemas/Metric" }
        "401": { description: Unauthorized }

  /insights/me:
    get:
      security: [{ bearerAuth: [] }]
      summary: Get latest insight for current student
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { $ref: "#/components/schemas/ApiStatus" }
                  data:
                    type: object
                    properties:
                      insight: { $ref: "#/components/schemas/Insight" }
        "401": { description: Unauthorized }
        "503": { description: ML service unavailable }